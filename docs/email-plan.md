# Email Plan (Direct-to-MX on Netcup VPS, Intellacc)

Goal: outbound-only email for password reset and email verification without a paid relay.

## Approach
Use Postfix in send-only mode + OpenDKIM for DKIM signing.
This VPS sends mail directly to recipient MX servers.

## Steps
1. Choose sending hostname.
Use: `mail.intellacc.com`

2. DNS records.
A record: `mail.intellacc.com -> VPS_IP`
SPF TXT at root (`intellacc.com`): `v=spf1 a mx ip4:VPS_IP -all`
DKIM TXT: generated by OpenDKIM (see below)
DMARC TXT at `_dmarc.intellacc.com`: `v=DMARC1; p=quarantine; rua=mailto:dmarc@intellacc.com`

3. rDNS/PTR at Netcup.
Set PTR for `VPS_IP` to `mail.intellacc.com`.
Must match the forward A record.

4. Install Postfix + OpenDKIM.
Postfix in send-only mode.
OpenDKIM signs outbound messages.

5. Postfix send-only essentials (`/etc/postfix/main.cf`):
```
myhostname = mail.intellacc.com
mydomain = intellacc.com
myorigin = $mydomain
inet_interfaces = loopback-only
inet_protocols = ipv4
mydestination = localhost
mynetworks = 127.0.0.0/8
smtpd_helo_required = yes
smtp_tls_security_level = may
```

6. OpenDKIM essentials:
Generate key for `intellacc.com` and add DNS TXT.
Configure OpenDKIM milter in Postfix:
```
milter_default_action = accept
milter_protocol = 6
smtpd_milters = inet:127.0.0.1:8891
non_smtpd_milters = inet:127.0.0.1:8891
```

## App Wiring (Intellacc)
The backend sends email via Nodemailer using SMTP env vars.
Email is used for both verification and password reset.

Set these in `backend/.env` (already wired through `backend/docker-compose.yml`):
```
FRONTEND_URL=https://intellacc.com
EMAIL_TOKEN_SECRET=change_me_email_token_secret
PASSWORD_RESET_SECRET=change_me_password_reset_secret
PASSWORD_RESET_EXPIRY=1h
PASSWORD_RESET_DELAY_HOURS=168
PASSWORD_RESET_POLL_INTERVAL_MS=60000

SMTP_HOST=postfix
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=
SMTP_PASS=
SMTP_FROM=noreply@intellacc.com
```

## Docker Setup (Intellacc)
Postfix runs in a Docker container on `intellacc-network`.
Service name: `postfix` (so `SMTP_HOST=postfix`).
Image: `boky/postfix:latest` (Alpine-based, send-only capable).
DKIM keys volume: `backend/postfix/keys -> /etc/opendkim/keys`.

## Docker Connectivity Notes
The backend connects to Postfix over the internal Docker network on port 587.

## Notes
- Deliverability depends on correct SPF/DKIM/DMARC and rDNS.
- New IPs need warming; expect throttling early on.
- Send-only mode avoids running a public SMTP relay.

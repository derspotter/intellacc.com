services:
  postfix:
    image: boky/postfix:latest
    container_name: postfix
    environment:
      HOSTNAME: mail.intellacc.com
      ALLOWED_SENDER_DOMAINS: intellacc.com
    volumes:
      - ./postfix/keys:/etc/opendkim/keys:ro
    networks:
      - intellacc-network

  db:
    image: postgres:17-alpine
    container_name: intellacc_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - intellacc-network

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: intellacc_backend
    environment:
      INTELLACC_STACK: production
      NODE_ENV: ${NODE_ENV}
      PORT: ${NODE_PORT}
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      FEDERATION_BASE_URL: ${FEDERATION_BASE_URL:-}
      APP_PUBLIC_URL: ${APP_PUBLIC_URL:-}
      ATPROTO_OAUTH_CLIENT_ID: ${ATPROTO_OAUTH_CLIENT_ID:-}
      ATPROTO_OAUTH_SCOPES: "${ATPROTO_OAUTH_SCOPES:-atproto transition:generic}"
      MASTODON_OAUTH_SCOPES: "${MASTODON_OAUTH_SCOPES:-read:accounts}"
      SOCIAL_AUTH_STATE_TTL_SECONDS: ${SOCIAL_AUTH_STATE_TTL_SECONDS:-600}
      ATPROTO_CREDENTIAL_SECRET: ${ATPROTO_CREDENTIAL_SECRET:-}
      ATPROTO_WORKER_INTERVAL_MS: ${ATPROTO_WORKER_INTERVAL_MS:-15000}
      FRONTEND_URL: ${FRONTEND_URL}
      EMAIL_TOKEN_SECRET: ${EMAIL_TOKEN_SECRET}
      PASSWORD_RESET_SECRET: ${PASSWORD_RESET_SECRET}
      PASSWORD_RESET_EXPIRY: ${PASSWORD_RESET_EXPIRY}
      PASSWORD_RESET_DELAY_HOURS: ${PASSWORD_RESET_DELAY_HOURS}
      PASSWORD_RESET_POLL_INTERVAL_MS: ${PASSWORD_RESET_POLL_INTERVAL_MS}
      PASSWORD_RESET_COOLDOWN_SECONDS: ${PASSWORD_RESET_COOLDOWN_SECONDS}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_SECURE: ${SMTP_SECURE}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_FROM: ${SMTP_FROM}
      SMTP_TLS_REJECT_UNAUTHORIZED: ${SMTP_TLS_REJECT_UNAUTHORIZED:-true}
      SMTP_IGNORE_TLS: ${SMTP_IGNORE_TLS:-false}
      PREDICTION_ENGINE_AUTH_TOKEN: ${PREDICTION_ENGINE_AUTH_TOKEN}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
      VAPID_EMAIL: ${VAPID_EMAIL}
    volumes:
      - ./src:/usr/src/app/src    # Only mount source code for live updates
      - ./test:/usr/src/app/test  # for testing
      - ./migrations:/usr/src/app/migrations  # mount migrations for auto-run
      - ./uploads:/usr/src/app/uploads
    working_dir: /usr/src/app
    ports:
      - "${NODE_PORT}:3000"
    command: ["./scripts/docker-dev-entrypoint.sh"]
    depends_on:
      - db
    networks:
      - intellacc-network

  # caddy:
  #   image: caddy:latest
  #   container_name: intellacc_caddy
  #   environment:
  #     - ACME_AGREE=true
  #     - EMAIL=${CADDY_EMAIL}
  #   volumes:
  #     - ./Caddyfile:/etc/caddy/Caddyfile
  #     - ./uploads:/uploads
  #     - caddy_data:/data
  #     - caddy_config:/config
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #     - "443:443/udp"
  #   depends_on:
  #     - backend
  #   networks:
  #     - intellacc-network

networks:
  intellacc-network:
    external: true

volumes:
  db-data:
  # caddy_data:
  # caddy_config:
